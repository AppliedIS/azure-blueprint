  {
      "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
          "environmentName": {
              "type": "string"
          },
          "adminUsername": {
              "type": "string",
              "metadata": {
                  "description": "Username for the Virtual Machine."
              }
          },
          "adminPassword": {
              "type": "securestring",
              "metadata": {
                  "description": "Password for the Virtual Machine."
              }
          },
          "dnsLabelPrefix": {
              "type": "string",
              "metadata": {
                  "description": "DNS Label for the Public IP. Must be lowercase. It should match with the following regular expression: ^[a-z][a-z0-9-]{1,61}[a-z0-9]$ or it will raise an error."
              }
          },
          "omsWorkspaceName": {
              "type": "string",
              "metadata": {
                  "description": "Assign a name for the Log Analytic Workspace Name"
              }
          },
          "omsWorkspaceRegion": {
              "type": "string",
              "defaultValue": "USGov Virginia",
              "allowedValues": ["USGov Virginia", "East US", "West Europe", "Southeast Asia", "Australia Southeast"],
              "metadata": {
                  "description": "Specify the region for your Workspace"
              }
          },
          "serviceTier": {
              "type": "string",
              "allowedValues": [
                  "Free",
                  "Standalone",
                  "PerNode"
              ],
              "defaultValue": "Free",
              "metadata": {
                  "description": "Service Tier: Free, Standalone, or PerNode"
              }
          },
          "dataRetention": {
              "type": "int",
              "defaultValue": 365,
              "minValue": 7,
              "maxValue": 730,
              "metadata": {
                  "description": "Number of days of retention. Free plans can only have 7 days, Standalone and OMS plans include 30 days for free"
              }
          },
          "omsAutomationAccountName": {
              "type": "string",
              "metadata": {
                  "description": "Assign a name for the Log Analytic Workspace Name"
              }
          },
          "keyVaultName": {
              "type": "string",
              "metadata": {
                  "description": "Name of the KeyVault to place the volume encryption key"
              }
          },
          "keyVaultResourceGroupName": {
              "type": "string",
              "metadata": {
                  "description": "Resource group of the KeyVault"
              }
          },
          "scheduleName": {
              "type": "string",
              "defaultValue": "VMPatchSchedule"
          },
          "scheduleJobGuid": {
              "type": "string",
          },
          "windowsOSVersion": {
              "type": "string",
              "defaultValue": "2012-R2-Datacenter",
              "allowedValues": [
                  "2008-R2-SP1",
                  "2012-Datacenter",
                  "2012-R2-Datacenter",
                  "Windows-Server-Technical-Preview"
              ],
              "metadata": {
                  "description": "The Windows version for the VM. This will pick a fully patched image of this given Windows version. Allowed values: 2008-R2-SP1, 2012-Datacenter, 2012-R2-Datacenter, Windows-Server-Technical-Preview."
              }
          },
          "templatesBaseUrl": {
              "type": "string",
              "defaultValue": "https://dctemplates.blob.core.usgovcloudapi.net/nestedtemplates"
          },
          "scriptsBaseUrl": {
              "type": "string",
              "defaultValue": "https://dctemplates.blob.core.usgovcloudapi.net/dsc"
          }
      },
      "variables": {
          "provisioningOMSWorkspaceUrl": "[concat(parameters('templatesBaseUrl'),'/createOMSWorkspace.json')]",
          "provisioningOMSWorkspace": "CreateOMSWorkspace",
          "provisioningVMUrl": "[concat(parameters('templatesBaseUrl'),'/createVMS.json')]",
          "provisioningOMSAutomationScheduleUrl": "[concat(parameters('templatesBaseUrl'),'/createAutomationSchedule.json')]",
          "keyVaultId": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('keyVaultResourceGroupName'), '/providers/Microsoft.KeyVault/vaults/', parameters('keyVaultName'))]",
          "vmSettings": {
              "storageAccountName": "[concat(uniquestring(resourceGroup().id), 'standardsa')]",
              "apiVersion": "2015-06-15",
              "imagePublisher": "MicrosoftWindowsServer",
              "imageOffer": "WindowsServer",
              "OSDiskName": "osdiskfor",
              "nicName": "myVMNic",
              "addressPrefix": "10.0.0.0/16",
              "subnetPrefix": "10.0.0.0/24",
              "storageAccountType": "Standard_GRS",
              "publicIPAddressName": "myPublicIP",
              "publicIPAddressType": "Dynamic",
              "vmStorageAccountContainerName": "vhds",
              "vmName": "MyOMSTestVM",
              "vmSize": "Standard_DS1",
              "resourceId": "[resourceGroup().id]",
              "subnetName": "Subnet",
              "virtualNetworkName": "MyVNET"
          },
          "vmNames": {
              "VMs": [{
                      "Name": "MyOMSTestVM"
                  },
                  {
                      "Name": "MyOMSTestVM01"
                  }
              ]
          },
          "simpleIISServerModulesURL": "[concat(parameters('scriptsBaseUrl'),'/SimpleIISServer.ps1.zip')]",
          "simpleIISServerConfigurationFunction": "SimpleIISServer.ps1\\SimpleIISServer",
          "setSecurityPolicyModulesURL": "[concat(parameters('scriptsBaseUrl'),'/SetSecurityPolicy.ps1.zip')]",
          "setSecurityPolicyConfigurationFunction": "SetSecurityPolicy.ps1\\SetSecurityPolicy",
          "setApplockerRulesModulesURL": "[concat(parameters('scriptsBaseUrl'),'/SetApplockerRules.ps1.zip')]",
          "setApplockerRulesConfigurationFunction": "SetApplockerRules.ps1\\SetApplockerRules",
          "getHybridWorkersIdURL": "[concat(parameters('scriptsBaseUrl'),'/getHybridWorkersId.ps1.zip')]",
          "getHybridWorkersIdConfigurationFunction": "getHybridWorkersId.ps1\\getHybridWorkersId"
      },
      "resources": [{
              "name": "CreateOMSWorkspace",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2015-01-01",
              "properties": {
                  "mode": "Incremental",
                  "templateLink": {
                      "uri": "[variables('provisioningOMSWorkspaceUrl')]",
                      "contentVersion": "1.0.0.0"
                  },
                  "parameters": {
                      "omsWorkspaceName": {
                          "value": "[parameters('omsWorkspaceName')]"
                      },
                      "omsWorkspaceRegion": {
                          "value": "[parameters('omsWorkspaceRegion')]"
                      },
                      "serviceTier": {
                          "value": "[parameters('serviceTier')]"
                      },
                      "dataRetention": {
                          "value": "[parameters('dataRetention')]"
                      },
                      "omsAutomationAccountName": {
                          "value": "[parameters('omsAutomationAccountName')]"
                      },
                      "scheduleName": {
                          "value": "[parameters('scheduleName')]"
                      },
                      "scheduleJobGuid": {
                          "value": "[parameters('scheduleJobGuid')]"
                      },
                      "artifactsLocation": {
                          "value": "[parameters('scriptsBaseUrl')]"
                      }
                  }
              }
          },
          {
              "name": "[concat('ConfigurationVMs', variables('vmNames').VMs[copyIndex()].Name)]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2015-01-01",
              "comments": "Create VMs",
              "dependsOn": [
                  "Microsoft.Resources/deployments/CreateOMSWorkspace"
              ],
              "copy": {
                  "name": "createVMsLoop",
                  "count": "[length(variables('vmNames').VMs)]"
              },
              "properties": {
                  "mode": "Incremental",
                  "templateLink": {
                      "uri": "[variables('provisioningVMUrl')]",
                      "contentVersion": "1.0.0.0"
                  },
                  "parameters": {
                      "adminUsername": {
                          "value": "[parameters('adminUsername')]"
                      },
                      "adminPassword": {
                          "value": "[parameters('adminPassword')]"
                      },
                      "vmName": {
                          "value": "[variables('vmNames').VMs[copyIndex()].Name]"
                      },
                      "dnsLabelPrefix": {
                          "value": "[parameters('dnsLabelPrefix')]"
                      },
                      "workspaceName": {
                          "value": "[parameters('omsWorkspaceName')]"
                      },
                      "windowsOSVersion": {
                          "value": "[parameters('windowsOSVersion')]"
                      },
                      "virtualMachineSettings": {
                          "value": "[variables('vmSettings')]"
                      },
                      "ResourceGroupName": {
                          "value": "[resourceGroup().name]"
                      },
                      "AutomationAccountName": {
                          "value": "[parameters('omsAutomationAccountName')]"
                      },
                      "AzureUserName": {
                          "reference": {
                              "keyVault": {
                                  "id": "[variables('keyVaultId')]"
                              },
                              "secretName": "azureUserName"
                          }
                      },
                      "AzurePassword": {
                          "reference": {
                              "keyVault": {
                                  "id": "[variables('keyVaultId')]"
                              },
                              "secretName": "azurePassword"
                          }
                      },
                      "SubscriptionId": {
                          "value": "[subscription().subscriptionId]"
                      },
                      "EnvironmentName": {
                          "value": "[parameters('environmentName')]"
                      },
                      "DSCHybridWorkersIdURL": {
                          "value": "[variables('getHybridWorkersIdURL')]"
                      },
                      "DSCHybridWorkersIdConfigurationFunction": {
                          "value": "[variables('getHybridWorkersIdConfigurationFunction')]"
                      }
                  }
              }
          },

          /*{
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "name": "[concat(variables('vmNames').VMs[copyIndex()].Name,'/setApplockerRulesPrepare')]",
              "apiVersion": "2015-06-15",
              "location": "[resourceGroup().location]",
              "dependsOn": [
                  "Microsoft.Resources/deployments/CreateOMSWorkspace",
                  "createVMsLoop"
              ],
              "copy": {
                  "name": "VMLoopUpdateApplocker",
                  "count": "[length(variables('vmNames').VMs)]"
              },
              "properties": {
                  "publisher": "Microsoft.Powershell",
                  "type": "DSC",
                  "typeHandlerVersion": "2.19",
                  "autoUpgradeMinorVersion": false,
                  "settings": {
                      "modulesURL": "[variables('setApplockerRulesModulesURL')]",
                      "configurationFunction": "[variables('setApplockerRulesConfigurationFunction')]",
                      "properties": {
                          "MachineName": "[variables('vmNames').VMs[copyIndex()].Name]"
                      },
                      "protectedSettings": null
                  }
              }
          },*/
          /*{
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "name": "[concat(variables('vmSettings').vmName,'/GetHybridWorkersId')]",
              "apiVersion": "2015-06-15",
              "location": "[resourceGroup().location]",
              "dependsOn": [
                  // "Microsoft.Resources/deployments/CreateOMSWorkspace",
                  // "createVMsLoop"
              ],
              "properties": {
                  "publisher": "Microsoft.Powershell",
                  "type": "DSC",
                  "typeHandlerVersion": "2.19",
                  "autoUpgradeMinorVersion": false,
                  "settings": {
                      "modulesURL": "[variables('getHybridWorkersIdURL')]",
                      "configurationFunction": "[variables('getHybridWorkersIdConfigurationFunction')]",
                      "properties": {
                          "MachineName": "[variables('vmSettings').vmName]",
                          "ResourceGroupName": "[resourceGroup().name]",
                          "AutomationAccountName": "[parameters('omsAutomationAccountName')]",
                          "AzureUserName": {
                              "reference": {
                                  "keyVault": {
                                      "id": "[variables('keyVaultId')]"
                                  },
                                  "secretName": "azureUserName"
                              }
                          },
                          "AzurePassword": {
                              "reference": {
                                  "keyVault": {
                                      "id": "[variables('keyVaultId')]"
                                  },
                                  "secretName": "azurePassword"
                              }
                          },
                          "SubscriptionId": "[subscription().subscriptionId]",
                          "EnvironmentName": "AzureCloud"
                      },
                      "protectedSettings": null
                  }
              }
          },*/
          {
              "name": "ConfigurationAutomationSchedules",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2015-01-01",
              "dependsOn": [
                  "Microsoft.Resources/deployments/CreateOMSWorkspace",
                  //"[resourceId('Microsoft.Compute/virtualMachines/extensions',variables('vmSettings').vmName,'GetHybridWorkersId')]"
                  "createVMsLoop"
              ],
              "properties": {
                  "mode": "Incremental",
                  "templateLink": {
                      "uri": "[variables('provisioningOMSAutomationScheduleUrl')]",
                      "contentVersion": "1.0.0.0"
                  },
                  "parameters": {
                      "omsWorkspaceName": {
                          "value": "[parameters('omsWorkspaceName')]"
                      },
                      "omsWorkspaceRegion": {
                          "value": "[parameters('omsWorkspaceRegion')]"
                      },
                      "serviceTier": {
                          "value": "[parameters('serviceTier')]"
                      },
                      "dataRetention": {
                          "value": "[parameters('dataRetention')]"
                      },
                      "omsAutomationAccountName": {
                          "value": "[parameters('omsAutomationAccountName')]"
                      },
                      "scheduleName": {
                          "value": "[parameters('scheduleName')]"
                      },
                      "scheduleJobGuid": {
                          "value": "[parameters('scheduleJobGuid')]"
                      },
                      "computerIdList": {
                          "value": ""
                      }
                  }
              }
          }
      ],
      "outputs": {
          /*"WorkspaceKeyFromNestTemplate": {
              "type": "string",
              "value": "[reference('CreateOMSWorkspace').outputs.OMSWorkspaceKey.value]"
          },
          /*"OMSWorkspaceId": {
              "type": "string",
              "value": "[reference(Concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', 'OMSWorkspaceId'), '2015-10-31').value]"
          },*/
          /*"HybridWorkerGroupNames": {
              "type": "string",
              "value": "[reference(Concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', 'ComputerIdList'), '2015-10-31').value]"
          }*/
      }
  }