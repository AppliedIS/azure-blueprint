{  
  "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion":"1.0.0.0",
  "parameters":{  
    "sqlVMName":{  
        "type":"string"
    },
    "location":{  
        "type":"string"
    },
    "adminUsername":{  
        "type":"string"
    },
    "adminPassword":{  
        "type":"securestring"
    },
    "domainName":{  
        "type":"string"
    },
    "sqlAOEPName":{  
        "type":"string"
    },
    "sqlServerServiceAccountUserName":{  
        "type":"string"
    },
    "sqlServerServiceAccountPassword":{  
        "type":"securestring"
    },
    "sql1ModulesURL":{  
        "type":"string"
    },
    "sql1ConfigurationFunction":{  
        "type":"string"
    },
    "clusterName":{  
        "type":"string"
    },
    "sharePath":{  
        "type":"string"
    },
    "sqlAOAGName":{  
        "type":"string"
    },
    "sqlAOListenerName":{  
        "type":"string"
    },
    "sqlAOListenerPort":{  
        "type":"string"
    },
    "sqlLBName":{  
        "type":"string"
    },
    "sqlLBIPAddress":{  
        "type":"string"
    },
    "adPDCVMName":{  
        "type":"string"
    },
    "sqlwVMName":{  
        "type":"string"
    },
    "numberOfDisks":{  
        "type":"string"
    },
    "workloadType": {
      "type": "string"
    },
    "antimalwareInfo": {
      "type": "object"
    }
   },
  "resources": [
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('sqlVMName'),'1/SQL1BaselineDSC')]",
      "apiVersion": "2015-06-15",
      "tags": {
        "Project": "BluePrint"
      },
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.19",
        "autoUpgradeMinorVersion": false,
        "settings": {
          "modulesURL": "[parameters('sql1ModulesURL')]",
          "configurationFunction": "[parameters('sql1ConfigurationFunction')]",
          "properties": {
            "domainName": "[parameters('domainName')]",
            "clusterName": "[parameters('clusterName')]",
            "sharePath": "[concat('\\\\',parameters('sqlwVMName'),'\\',parameters('sharePath'))]",
            "nodes": [
              "[concat(parameters('sqlVMName'),'0')]",
              "[concat(parameters('sqlVMName'),'1')]"
            ],
            "sqlAlwaysOnEndpointName": "[parameters('sqlAOEPName')]",
            "sqlAlwaysOnAvailabilityGroupName": "[parameters('sqlAOAGName')]",
            "sqlAlwaysOnAvailabilityGroupListenerName": "[parameters('sqlAOListenerName')]",
            "SqlAlwaysOnAvailabilityGroupListenerPort": "[parameters('sqlAOListenerPort')]",
            "databaseNames": "AutoHa-sample",
            "lbName": "[parameters('sqlLBName')]",
            "lbAddress": "[parameters('sqlLBIPAddress')]",
            "primaryReplica": "[concat(parameters('sqlVMName'),'1')]",
            "secondaryReplica": "[concat(parameters('sqlVMName'),'0')]",
            "dnsServerName": "[parameters('adPDCVMName')]",
            "adminCreds": {
              "userName": "[parameters('adminUserName')]",
              "password": "privateSettingsRef:adminPassword"
            },
            "sqlServiceCreds": {
              "userName": "[parameters('sqlServerServiceAccountUserName')]",
              "password": "privateSettingsRef:sqlServerServiceAccountPassword"
            },
            "SQLAuthCreds": {
              "userName": "sqlsa",
              "password": "privateSettingsRef:sqlAuthPassword"
            },
            "NumberOfDisks": "[parameters('numberOfDisks')]",
            "WorkloadType": "[parameters('workloadType')]"
            /*,
            "ExclusionPath": "[parameters('antimalwareInfo').exclusionPath.sql]",
            "ExclusionExtension": "[parameters('antimalwareInfo').exclusionExtension.sql]",
            "ExclusionProcess": "[parameters('antimalwareInfo').exclusionProcess.sql]",
            "RealTimeScanDirection": "[parameters('antimalwareInfo').realTimeScanDirection]",
            "RemediationScheduleDay": "[parameters('antimalwareInfo').remediationScheduleDay]",
            "ScanScheduleDay": "[parameters('antimalwareInfo').scanScheduleDay]",
            "DisableRealtimeMonitoring": "[parameters('antimalwareInfo').disableRealtimeMonitoring]"
            */
          }
        },
        "protectedSettings": {
          "items": {
            "adminPassword": "[parameters('adminPassword')]",
            "sqlServerServiceAccountPassword": "[parameters('sqlServerServiceAccountPassword')]",
            "sqlAuthPassword": "[parameters('sqlServerServiceAccountPassword')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('sqlVMName'),'1/Antimalware')]",
      "apiVersion": "2016-04-30-preview",
      "location": "[parameters('location')]",
      "tags": {
        "Project": "BluePrint"
      },
      "dependsOn": "[resourceId('Microsoft.Compute/virtualMachines/extensions',concat(parameters('sqlVMName'),'1'),'SQL1BaselineDSC')]",
      "properties": {
        "publisher": "Microsoft.Azure.Security",
        "type": "IaaSAntimalware",
        "typeHandlerVersion": "1.3",
        "settings": {
          "AntimalwareEnabled": "true",
          "Exclusions": {
            "Paths": "[parameters('antimalwareInfo').exclusionPath.sql]",
            "Extensions": "[parameters('antimalwareInfo').exclusionExtension.sql]",
            "Processes": "[parameters('antimalwareInfo').exclusionProcess.sql]"
          },
          "RealtimeProtectionEnabled": "true",
          "ScheduledScanSettings": {
            "isEnabled": "true",
            "scanType": "Full",
            "day": "0",
            "time": "60"
          }
        },
        "protectedSettings": null
      }
    }
  ],
   "outputs":{  

   }
}